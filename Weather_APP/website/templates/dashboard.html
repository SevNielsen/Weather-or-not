{% extends "navbar.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<style>
body {
    background: linear-gradient(135deg, rgba(135,221,255,1) 0%, rgba(255,255,255,1) 100%);
    font-family: 'Arial', sans-serif;
    color: #333;
}

.custom-card, .custom-card1, .custom-card7, .custom-card2 {
    background: #ffffff; 
    border-radius: 30px; 
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1); 
    transition: transform 0.3s ease; 
}

.custom-card:hover, .custom-card1:hover, .custom-card7:hover, .custom-card2:hover {
    transform: translateY(-5px); 
}

.card-body {
    padding: 20px;
    text-align: center; 
}

/* Enhanced styling for chart and map sections */
.chart-section, .map-section {
    margin-top: 30px;
    background: #f9f9f9; 
    padding: 30px;
    border-radius: 30px;
    box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
    display: flex;
    flex-direction: column;
    align-items: center; 
}

.chart-section h5, .map-section h5 {
    margin-bottom: 20px;
    color: #007bff; 
}


.btn-outline-primary {
    border-color: #007bff;
    color: #007bff;
    border-radius: 20px; 
    padding: 10px 20px;
}

.btn-outline-primary:hover {
    background: #007bff;
    color: #fff;
}

.input-group {
    border-radius: 20px;
    overflow: hidden; 
}

.form-control {
    border: 2px solid #007bff; 
    box-shadow: none;
}

.form-control:focus {
    border-color: #0056b3;
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
}
</style>
<!-- Bootstrap CSS for styling and responsiveness -->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css">
<link rel="stylesheet" href="{{ url_for('static', filename='leaflet-openweathermap.css') }}">
<div class="container-fluid mt-4">
    <!-- Alerts for messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% if messages[0][0] == 'created_account' %}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
      {{ messages[0][1] }}
      <button type="button" class="close" data-dismiss="alert" aria-label="Close">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
    {% endif %}
    {% endif %}
    {% endwith %}
    <!-- Search Bar -->
    <div class="row justify-content-end">
      <div class="col-lg-4">
        <form method="POST" class="input-group mb-3">
          <input type="search" id="search" class="form-control" placeholder="Search for a location" aria-label="Search" name="city">
          <div class="input-group-append">
            <button class="btn btn-outline-secondary" type="submit"><i class="fas fa-search"></i></button>
          </div>
        </form>
      </div>
    </div>
    <!-- Current Weather and Map -->
    <div class="container-fluid mt-4"> 
        <div class="row">
          <!-- Current Weather Column -->
          <div class="col-lg-4">
            <div class="card text-center">
              <div class="card-body">
                <h5 class="card-title">
                  {{ current_weather.city }}, {{ current_weather.country }}
                </h5>
                <img src="{{ current_weather.icon }}" alt="Weather Icon" class="my-3" style="width: 80px;"> <!-- Increased size slightly for focus -->
                <h6 class="card-subtitle mb-2 text-muted">
                  <span class="badge badge-primary">{{ current_weather.weather_description }}</span>
                </h6>
                <div class="my-3">
                  <span class="font-weight-bold" style="font-size: 1.5em;">{{ current_weather.temperature }}°C</span>
                  <div class="text-muted">Feels like: {{ current_weather.feels_like }}°C</div>
                </div>
                <div class="my-4">
                  <div class="row">
                    <div class="col">
                      Humidity: {{ current_weather.humidity }}%<br>
                      Pressure: {{ current_weather.pressure }} hPa
                    </div>
                    <div class="col">
                      Wind: {{ current_weather.wind_speed }} m/s<br>
                      Visibility: {{ current_weather.visibility }} meters
                    </div>
                  </div>
                </div>
              </div>
              <div class="card-footer text-muted">
                <div class="row">
                  <div class="col">Sunrise: {{ current_weather.sunrise }}</div>
                  <div class="col">Sunset: {{ current_weather.sunset }}</div>
                </div>
              </div>
            </div>
          </div>
          <!-- Map Column -->
          <div class="col-lg-8">
            <div class="card">
              <div class="card-body">
                <h5 class="card-title">Weather Map</h5>
                <div id="map" style="height: 400px;"> </div>
                <div class="map-layer-controls"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
   <!-- 5 Day Forecast -->
<div class="card mt-3">
    <div class="card-body">
      <h5 class="card-title">5 Day Forecast</h5>
      <div class="row">
        {% for forecast in forecasts %}
        <div class="col-md-2 col-sm-4 mb-3">
          <div class="custom-card2">
            <div class="d-flex">
              <div class="flex-grow-1 mt-2 text-center">
                <p>
                  <span>{{ forecast['date'] }}</span><br />
                  <span><img src="{{ forecast['icon'] }}" alt="Weather Icon"></span><br />
                  <span>{{ forecast['max_temp'] }}°</span><br />
                  <span>{{ forecast['min_temp'] }}°</span><br />
                  <span>{{ forecast['description'] }}</span>
                </p>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
    <!-- Weather Chart -->
    <div class="card mt-3">
      <div class="card-body">
        <h5 class="card-title">Weather Chart</h5>
        <canvas id="weatherChart"></canvas> <!-- Chart Placeholder -->
      </div>
    </div>
  </div>
  <!-- jQuery first, then Popper.js, then Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="{{ url_for('static', filename='leaflet-openweathermap.js') }}"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
        var map = L.map('map').setView([49.886, -119.496], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);
    
        fetch('/config').then(response => response.json()).then(config => {
            var apiKey = config.apiKey;
            var currentLayer = null;
            var layers = {
            temp: L.OWM.temperature({appId: apiKey, showLegend: true, legendPosition: 'bottomleft'}),
            pressure: L.OWM.pressure({appId: apiKey, showLegend: true, legendPosition: 'bottomleft'}),
            wind: L.OWM.wind({appId: apiKey, showLegend: true, legendPosition: 'bottomleft'}),
            clouds: L.OWM.clouds({appId: apiKey, showLegend: true, legendPosition: 'bottomleft'}),
            precip: L.OWM.precipitation({appId: apiKey, showLegend: true, legendPosition: 'bottomleft'})
            };

            var controlPanel = L.control({position: 'topright'});
            controlPanel.onAdd = function(map) {
                var div = L.DomUtil.create('div', 'layer-control-panel btn-group-vertical');
                div.style.zIndex = "1000"; 
                div.innerHTML = Object.keys(layers).map(function(layer) {
                    return `<button type="button" class="btn btn-outline-secondary btn-sm mb-1" data-layer="${layer}" aria-label="Show ${layer} layer">${layer.charAt(0).toUpperCase() + layer.slice(1)}</button>`;
                }).join('') + `<button type="button" class="btn btn-danger btn-sm mt-2" id="clearLayers" aria-label="Clear layers">Clear Layers</button>`;
                return div;
            };
            controlPanel.addTo(map);
    
            L.DomEvent.on(controlPanel.getContainer(), 'click', function(e) {
                var buttons = document.querySelectorAll('.layer-control-panel button');
                buttons.forEach(button => button.classList.remove('active')); 
    
                if (e.target && e.target.dataset.layer) {
                    switchLayer(e.target.dataset.layer);
                    e.target.classList.add('active'); 
                } else if (e.target && e.target.id === 'clearLayers') {
                    clearLayers();
                }
            });
    
            function switchLayer(layerName) {
                clearLayers();
                currentLayer = layers[layerName];
                map.addLayer(currentLayer);
            }
    
            function clearLayers() {
                if (currentLayer) {
                    map.removeLayer(currentLayer);
                    currentLayer = null;
                }
            }
        }).catch(error => console.error("Failed to fetch API key:", error));
    });
    </script>
    
{% endblock %}